- 日期: 2019-12-12
- RFC PR: 
- Issue: 

# 总结

引入插件机制，通过插件机制可以增强 Remax 的功能，包括但不限于:
  * 支持多平台
  * 扩展语法支持能力
  * 切换渲染引擎，如 rax
  * 自定义打包行为
  * 自定义 CLI 命令
  * 扩展平台功能
  * ...

# 基本例子

待补充

# 背景

Remax 目前的代码与平台有一定的耦合，我们要做到 remax 和 remax-cli 与平台无关。
Remax 目前支持跨平台的能力不强。
并且考虑到用户需求的灵活性，各平台的差异性，要有足够自由的空间给插件发挥。

Remax 的编译时与运行时流程图如下：

```
╔═══════════════════════════╗
            编译时           
╚═══════════════════════════╝
┏━━━━━━━━━━━━━━━┓
1. 处理 CLI 命令  
┗━━━━━━━━━━━━━━━┛
┏━━━━━━━━━━━━━━━━━━┓
2. 处理 RemaxConfig 
┗━━━━━━━━━━━━━━━━━━┛
┏━━━━━━━━━━━━━━━━━━┓
3. 引入 adapter 代码 
┗━━━━━━━━━━━━━━━━━━┛
┏━━━━━━━━━━━━━━━━━━━━┓
4. 处理 Rollup Config 
┗━━━━━━━━━━━━━━━━━━━━┛
  ┣━━━━━━━━━━━━━━━━━━━┓
  4.1 处理 Rollup 插件   
  ┗━━━━━━━━━━━━━━━━━━━┛
    ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.1 清理 output 目录                              
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.2 copy native 目录                             
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.3 alias                                 
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.4 url
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.5 node resolve
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.6 commonjs
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.7 stub
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.8 babel [收集 native 组件，处理 page 页面]
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
      ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
      4.1.10.1 引用 babel-preset-remax                 
      ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.9 babel [收集 native 组件，处理 app 页面]
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.10 babel [收集 native 组件，收集需要生成的原生模板] 
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
      ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
      4.1.10.2 处理 createHostComponent 收集到的 host 组件  
      ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.11 postcss                                    
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
      ┣━━━━━━━━━━━━━━━━━┓
      4.1.11.1 px 转 rpx 
      ┗━━━━━━━━━━━━━━━━━┛
      ┏━━━━━━━━━━━━━━━━━┓
      4.1.11.2 url       
      ┗━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.12 处理 json 文件                               
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.13 处理环境变量                        
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.14 文件重命名
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.15 去除路径中的 src
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.16. fix regenerateRuntime
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.17 收集 native 组件引用
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.18 生成原生文件
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    4.1.19 显示 build 进度
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
  ┏━━━━━━━━━━━━━━━━━━━━━━━┓
  4.2. 处理 Rollup Options
  ┗━━━━━━━━━━━━━━━━━━━━━━━┛
┏━━━━━━━━━━━━━━━━━━━┓
5. 处理 watch       
┗━━━━━━━━━━━━━━━━━━━┛
┏━━━━━━━━━━━━━━━━━━━┓
6. rollup build     
┗━━━━━━━━━━━━━━━━━━━┛
┏━━━━━━━━━━━━━━━━━━━┓
5. rollup write    
┗━━━━━━━━━━━━━━━━━━━┛


╔═══════════════════════════╗
            运行时           
╚═══════════════════════════╝
┏━━━━━━━━━━━━━━━┓
1. 创建 App 对象  
┗━━━━━━━━━━━━━━━┛
  ┣━━━━━━━━━━━━━━━━━━━━━┓
  1.1 注册App生命周期
  ┗━━━━━━━━━━━━━━━━━━━━━┛
  ┏━━━━━━━━━━━━━━━━━━━━━┓
  1.2. 创建 AppContainer
  ┗━━━━━━━━━━━━━━━━━━━━━┛
  ┏━━━━━━━━━━━━━━━━━━━━━┓
  1.3. 创建 React 实例
  ┗━━━━━━━━━━━━━━━━━━━━━┛
    ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    1.3.1 注册 HostConfig
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    1.3.2 创建 React root Container
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
┏━━━━━━━━━━━━━━━┓
2. 创建 Page 对象  
┗━━━━━━━━━━━━━━━┛
  ┣━━━━━━━━━━━━━━━━━━━━━┓
  2.1 注册Page生命周期
  ┗━━━━━━━━━━━━━━━━━━━━━┛
  ┏━━━━━━━━━━━━━━━━━━━━━┓
  2.2. Page render
  ┗━━━━━━━━━━━━━━━━━━━━━┛
    ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    2.2.1 创建 Container 实例
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    2.2.2 创建 React Element 实例
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    2.2.3 创建 Portal
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    2.2.4 更新 React root Container
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
┏━━━━━━━━━━━━━━━━━┓
3. React renderer  
┗━━━━━━━━━━━━━━━━━┛
  ┣━━━━━━━━━━━━━━━┓
  3.1 hostConfig
  ┗━━━━━━━━━━━━━━━┛
    ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    3.1.1 hooks 触发 Container 行为
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
      ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
      3.1.1.1 更新虚拟 dom
      ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
      ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
      3.1.1.2 requestUpdate, update 入列
      ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
      ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
      3.1.1.3 applyUpdate
      ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
        ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
        3.1.1.3.1 props 别名
        ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
        ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
        3.1.1.3.2 创建 update action
        ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
        ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
        3.1.1.3.3 执行原生 setData
        ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
      ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
      3.1.1.4 clearUpdate，停止更新行为
      ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    3.1.2 处理 props
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
      ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
      3.1.2.1 处理 SyntheticEvent 逻辑
      ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

# 详细设计

待补充

# 缺点

代码冗余会有一定程度上升，维护多平台的成本上升。

# 其他可选方案

无

# 其他问题